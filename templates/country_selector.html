<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sélection du pays - Internship Tracker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="{{ url_for('index') }}" class="nav-brand">Internship Tracker</a>
    </div>
  </nav>

  <!-- Flash Messages - Moved to appear immediately below navbar -->
  <div style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash-message flash-{{ category }}" style="margin-top: 1rem;">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}
  </div>

  <!-- Timer Interface -->
  <div class="timer-container">
    <h2 class="timer-title">Prochaine mise à jour automatique</h2>
    <div class="timer-display" id="nextUpdateTime">
      Chargement...
    </div>
    <div class="timer-info">
      Les offres sont mises à jour automatiquement toutes les 15 minutes
    </div>
  </div>

  <!-- Hero Section with Vibrant Background -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Bienvenue sur Internship Tracker</h1>
      <p class="hero-subtitle">Sélectionnez un pays pour découvrir les dernières offres de stage dans votre région</p>
    </div>
  </section>

  <div class="countries-grid">
    {% for country in countries %}
    <a href="{{ url_for('country_offers', country_name=country.name) }}" class="country-card">
      <div class="country-flag">{{ country.flag }}</div>
      <h2 class="country-name">{{ country.name }}</h2>
      <div class="country-offers">Voir les offres de stage</div>
    </a>
    {% endfor %}
  </div>

  <script>
    // Track if we're currently showing the "Mise à jour en cours..." message
    let isUpdating = false;
    let updateCheckInterval = null;
    
    // Function to update the timer display
    function updateTimerDisplay() {
      fetch('/timer-info')
        .then(response => response.json())
        .then(data => {
          // Debugging: log the data received
          console.log('Timer info data:', data);
          
          const nextRuns = data.next_runs;
          
          // Check if we have any valid next run times
          let hasValidNextRuns = false;
          let earliestTime = null;
          
          for (const jobId in nextRuns) {
            if (nextRuns[jobId]) {
              hasValidNextRuns = true;
              const jobTime = new Date(nextRuns[jobId]);
              if (!earliestTime || jobTime < earliestTime) {
                earliestTime = jobTime;
              }
            }
          }

          // If we don't have valid next run times, show a default message
          if (!hasValidNextRuns) {
            document.getElementById('nextUpdateTime').textContent = "Prochaine mise à jour: bientôt";
            // Reset the updating state
            if (isUpdating) {
              isUpdating = false;
              if (updateCheckInterval) {
                clearInterval(updateCheckInterval);
                updateCheckInterval = null;
              }
            }
            return;
          }

          if (earliestTime) {
            const now = new Date();
            const diffMs = earliestTime - now;
            const diffMins = Math.floor(diffMs / 60000);
            const diffSecs = Math.floor((diffMs % 60000) / 1000);

            if (diffMins > 0) {
              document.getElementById('nextUpdateTime').textContent =
                `${diffMins} minute${diffMins > 1 ? 's' : ''} et ${diffSecs} seconde${diffSecs > 1 ? 's' : ''}`;
              // Reset the updating state if we were showing "Mise à jour en cours..."
              if (isUpdating) {
                isUpdating = false;
                // Clear the update check interval if it exists
                if (updateCheckInterval) {
                  clearInterval(updateCheckInterval);
                  updateCheckInterval = null;
                }
              }
            } else if (diffSecs > 0) {
              document.getElementById('nextUpdateTime').textContent =
                `${diffSecs} seconde${diffSecs > 1 ? 's' : ''}`;
              // Reset the updating state if we were showing "Mise à jour en cours..."
              if (isUpdating) {
                isUpdating = false;
                // Clear the update check interval if it exists
                if (updateCheckInterval) {
                  clearInterval(updateCheckInterval);
                  updateCheckInterval = null;
                }
              }
            } else {
              // When time is up, show the updating message
              if (!isUpdating) {
                isUpdating = true;
                document.getElementById('nextUpdateTime').textContent = "Mise à jour en cours...";
                // Start checking for when the update is complete
                startUpdateCheck();
              }
            }
          } else {
            document.getElementById('nextUpdateTime').textContent = "Prochaine mise à jour: bientôt";
            // Reset the updating state
            if (isUpdating) {
              isUpdating = false;
              if (updateCheckInterval) {
                clearInterval(updateCheckInterval);
                updateCheckInterval = null;
              }
            }
          }
        })
        .catch(error => {
          console.error('Error fetching timer info:', error);
          document.getElementById('nextUpdateTime').textContent = "Erreur de chargement";
          // Reset the updating state on error
          if (isUpdating) {
            isUpdating = false;
            if (updateCheckInterval) {
              clearInterval(updateCheckInterval);
              updateCheckInterval = null;
            }
          }
        });
    }
    
    // Function to check if the update is complete and refresh the page
    function startUpdateCheck() {
      // Clear any existing interval
      if (updateCheckInterval) {
        clearInterval(updateCheckInterval);
      }
      
      // Check every 5 seconds if the update is complete
      updateCheckInterval = setInterval(() => {
        fetch('/timer-info')
          .then(response => response.json())
          .then(data => {
            console.log('Update check data:', data);
            
            const nextRuns = data.next_runs;
            
            // Check if we have any valid next run times in the future
            let hasFutureNextRuns = false;
            let earliestTime = null;
            
            for (const jobId in nextRuns) {
              if (nextRuns[jobId]) {
                const jobTime = new Date(nextRuns[jobId]);
                if (jobTime > new Date()) {
                  hasFutureNextRuns = true;
                  if (!earliestTime || jobTime < earliestTime) {
                    earliestTime = jobTime;
                  }
                }
              }
            }
            
            // If we have future next run times, the update is likely complete
            if (hasFutureNextRuns) {
              console.log('Update complete, refreshing page...');
              // Refresh the page to show new offers
              location.reload();
            }
          })
          .catch(error => {
            console.error('Error checking update status:', error);
          });
      }, 5000); // Check every 5 seconds
    }

    // Update timer immediately and then every second
    updateTimerDisplay();
    setInterval(updateTimerDisplay, 1000);
  </script>
</body>

</html>